image: Ubuntu
version: 0.1.0.{build}

branches:
  only:
    - /.*/

environment:
  STAGE: dev
  SNYK_TOKEN:
    secure: 9ff1FZB5xsovfQd4y4aiD+LHCY43z+D/p/kmQMQJEn/YAK22m9UsVJeL/o1GKpaP
  CODECOV_TOKEN:
    secure: FmqEfCU7TAhcdyDsRdOmv811QvAK0ttwRPyUrxM4U8nyKS99tZ9EEO4kbROTGuqx

for:
  - branches:
      only:
        - dev
    environment:
      STAGE: dev
  - branches:
      only:
        - main
    environment:
      STAGE: prod

install:
  - sh: |
      nvm use $(cat .nvmrc)
      npm install --quiet
      if [[ "$STAGE" == "dev" || "$STAGE" == "prod" ]]; then
        curl -Os https://uploader.codecov.io/latest/linux/codecov
        chmod +x codecov
      fi
build_script:
  - sh: |
      npm run lint
      npm run test
  - sh: |
      if [[ "$STAGE" == "dev" || "$STAGE" == "prod" ]]; then
        ./codecov
        npx snyk monitor
      fi
  - sh: |
      if [[ "$STAGE" == "dev" ]]; then
        npm run build -- --configuration=development
      elif [[ "STAGE" == "prod" ]]; then
        npm run build
      fi

artifacts:
  - path: .angular
    name: market-news-client-${env:STAGE}-${self:version}

deploy_script:
  - sh: echo 'Deployments are managed with AWS Amplify'
